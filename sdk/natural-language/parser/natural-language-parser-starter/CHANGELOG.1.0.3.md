# Changelog

## [1.0.3] - 2026-01-03

### ✨ 新特性

#### 聚合解析增强 - 支持复杂聚合查询

全面升级聚合解析能力，支持嵌套聚合、并行聚合和聚合参数。

**新增功能：**

1. **桶聚合（分组）**
    - TERMS 分组：`按城市分组`
    - 支持 size 参数：`按城市分组前10个`
    - DATE_HISTOGRAM 时间分组：`按创建时间每天统计`
    - 支持 interval 参数：`每小时`、`每天`、`每周`、`每月`

2. **嵌套聚合**
    - 在分组内计算指标：`按城市分组统计平均年龄`
    - 生成层级结构的聚合查询

3. **并行聚合**
    - 同时执行多个聚合：`按城市分组，同时按创建时间每天统计`
    - 支持分隔词：`同时`、`并且`、`还有`等

**示例：**

```text
查询：按城市分组前10个统计平均年龄，同时按创建时间每天统计
```

解析为2个并行聚合：

- 第1个：按城市分组（前10个），每组计算平均年龄
- 第2个：按创建时间每天分组统计

**支持的聚合类型：**

| 查询示例           | 聚合类型           | 说明        |
|----------------|----------------|-----------|
| `统计平均年龄`       | AVG            | 简单指标聚合    |
| `按城市分组`        | TERMS          | 桶聚合（分组）   |
| `按城市分组前10个`    | TERMS          | 带 size 参数 |
| `按创建时间每天统计`    | DATE_HISTOGRAM | 时间聚合      |
| `按城市分组统计平均年龄`  | TERMS + AVG    | 嵌套聚合      |
| `按城市分组，同时每天统计` | 多个聚合           | 并行聚合      |

### 🔧 技术改进

**1. 消除硬编码**

- 所有关键词统一由 `AggKeywords` 管理
- 新增方法：`isTermsPrefix()`、`isDateHistogramPrefix()`、`isIntervalKeyword()`

**2. 增强分词容错性**

- 移除对特定 `TokenType` 的依赖
- 基于文本内容匹配，适配 HanLP 分词变化

**3. 优先级解析**

- 先匹配完整关键词（如 `每天`）
- 再匹配通用前缀（如 `按`、`每`）
- 避免误识别（如 `按...降序` 不会被识别为聚合）

**4. 字段名合并**

- 支持合并连续的字段 tokens（如 `创建` + `时间` → `创建时间`）

**修改的文件：**

- `AggregationParser.java` - 聚合解析器核心逻辑
- `AggKeywords.java` - 关键词库扩展

### ✅ 测试覆盖

新增测试用例：

- `AggregationEnhancementTest.java` - 复杂聚合综合测试
- `AggregationParserTest.java` - 详细的单元测试（20+ 场景）


### 🔄 升级说明

**兼容性：**

- ✅ 完全向后兼容
- ✅ 无破坏性变更
- ✅ 现有查询继续有效

**推荐升级理由：**

1. 支持更复杂的数据分析场景
2. 更好的分词容错能力
3. 更易维护的代码结构

**依赖版本：**

- 无新增依赖
- 与 v1.0.2 保持一致

### 🎯 使用场景

**电商分析：**

```text
按类目分组前20个统计总销售额，同时按下单时间每天统计
```

**用户行为分析：**

```text
按城市分组统计平均年龄，同时按注册时间每月统计
```

**日志分析：**

```text
按服务名分组前10个统计错误数，同时按时间每小时统计
```
