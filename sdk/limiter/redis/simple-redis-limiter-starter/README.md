# Simple Redis Limiter Starter

åŸºäºRedisçš„åˆ†å¸ƒå¼é™æµå™¨Spring Boot Starterï¼Œæä¾›Tokenæ¡¶å’ŒSeté›†åˆä¸¤ç§é™æµæ¨¡å¼ï¼Œæ”¯æŒå¤šå®ä¾‹ç¯å¢ƒä¸‹çš„åˆ†å¸ƒå¼é™æµæ§åˆ¶ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸš€ **åŒæ¨¡å¼é™æµ**ï¼šToken ä»¤ç‰Œæ¡¶ï¼ˆæ§åˆ¶æ€»é‡ï¼‰+ Set é›†åˆï¼ˆé˜²é‡å¤ï¼‰
- ğŸ”’ **åˆ†å¸ƒå¼å®‰å…¨**ï¼šåŸºäº Redis åˆ†å¸ƒå¼é”ï¼Œå¤šå®ä¾‹ç¯å¢ƒæ•°æ®ä¸€è‡´
- ğŸ”„ **è‡ªåŠ¨é‡ç½®**ï¼šCron å®šæ—¶ä»»åŠ¡è‡ªåŠ¨æ¢å¤ä»¤ç‰Œå’Œæ¸…ç†å»é‡é›†åˆ
- ğŸ›¡ï¸ **é‡è¯•æœºåˆ¶**ï¼šæŒ‡æ•°é€€é¿é‡è¯•ï¼Œåº”å¯¹ç½‘ç»œæŠ–åŠ¨
- âš™ï¸ **çµæ´»é…ç½®**ï¼šè‡ªå®šä¹‰ Key å‰ç¼€ã€ä»¤ç‰Œæ•°é‡ã€é‡ç½®å‘¨æœŸç­‰

## å¿«é€Ÿå¼€å§‹

### 1. æ·»åŠ ä¾èµ–

```gradle
dependencies {
    implementation "io.github.surezzzzzz:simple-redis-limiter-starter:1.0.0"
}
```

### 2. å¯ç”¨é™æµå™¨

åœ¨`application.yml`ä¸­æ·»åŠ é…ç½®ï¼š

```yaml
io:
  github:
    surezzzzzz:
      sdk:
        limiter:
          redis:
            enable: true  # å¯ç”¨é™æµå™¨
            me: myapp     # åº”ç”¨æ ‡è¯†ï¼Œç”¨äºåŒºåˆ†ä¸åŒåº”ç”¨å®ä¾‹
```

## é…ç½®è¯¦è§£

### åŸºç¡€é…ç½®

| é…ç½®é¡¹ | è¯´æ˜ | é»˜è®¤å€¼ |
|--------|------|--------|
| `enable` | æ˜¯å¦å¯ç”¨é™æµå™¨ | `false` |
| `me` | åº”ç”¨æ ‡è¯†ï¼Œç”¨äºåŒºåˆ†ä¸åŒå®ä¾‹ | `default` |
| `lockKey` | åˆ†å¸ƒå¼é”çš„Redis Key | `surezzzzzz_redis_limiter_lock` |
| `lockValue` | åˆ†å¸ƒå¼é”çš„Redis Value | éšæœºUUID |
| `lockExpiryTime` | é”çš„è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰ | `300` |
| `maxRetries` | æœ€å¤§é‡è¯•æ¬¡æ•° | `20` |
| `retryInterval` | é‡è¯•é—´éš”ï¼ˆæ¯«ç§’ï¼‰ | `30000` |

### Tokenæ¡¶é…ç½®

| é…ç½®é¡¹ | è¯´æ˜ | é»˜è®¤å€¼ |
|--------|------|--------|
| `token.enable` | æ˜¯å¦å¯ç”¨Tokenæ¡¶ | `true` |
| `token.reset` | æ˜¯å¦å¯ç”¨å®šæ—¶é‡ç½® | `true` |
| `token.cron` | é‡ç½®Cronè¡¨è¾¾å¼ | `0 0 0 * * ?` |
| `token.size` | ä»¤ç‰Œæ•°é‡ | `800000000` |
| `token.bucket` | Tokenæ¡¶çš„Redis Key | `surezzzzzz_redis_limiter_token_bucket` |

### Setæ¡¶é…ç½®

| é…ç½®é¡¹ | è¯´æ˜ | é»˜è®¤å€¼ |
|--------|------|--------|
| `set.enable` | æ˜¯å¦å¯ç”¨Setæ¡¶ | `true` |
| `set.reset` | æ˜¯å¦å¯ç”¨å®šæ—¶é‡ç½® | `true` |
| `set.cron` | é‡ç½®Cronè¡¨è¾¾å¼ | `0 0 0 * * ?` |
| `set.bucket` | Setæ¡¶çš„Redis Key | `surezzzzzz_redis_limiter_set_bucket` |
| `set.compressBucket` | å‹ç¼©Setæ¡¶çš„Redis Key | `surezzzzzz_redis_limiter_compress_set_bucket` |

## é«˜çº§ç”¨æ³•

### è‡ªå®šä¹‰Keyå‰ç¼€

```yaml
io:
  github:
    surezzzzzz:
      sdk:
        limiter:
          redis:
            enable: true
            me: payment-service  # æ‰€æœ‰Keyéƒ½ä¼šåŒ…å«è¿™ä¸ªæ ‡è¯†
            lockKey: custom_payment_limiter_lock
            initializedKey: custom_payment_limiter_initialized
```

### è°ƒæ•´é‡è¯•ç­–ç•¥

```yaml
io:
  github:
    surezzzzzz:
      sdk:
        limiter:
          redis:
            enable: true
            maxRetries: 30        # å¢åŠ é‡è¯•æ¬¡æ•°
            retryInterval: 10000  # ç¼©çŸ­é‡è¯•é—´éš”åˆ°10ç§’
            lockExpiryTime: 600  # å»¶é•¿é”è¿‡æœŸæ—¶é—´åˆ°10åˆ†é’Ÿ
```

### å®šæ—¶é‡ç½®é…ç½®

```yaml
io:
  github:
    surezzzzzz:
      sdk:
        limiter:
          redis:
            enable: true
            token:
              reset: true
              cron: "0 0 8,20 * * ?"  # æ¯å¤©8ç‚¹å’Œ20ç‚¹é‡ç½®Tokenæ¡¶
            set:
              reset: true
              cron: "0 30 2 * * ?"    # æ¯å¤©å‡Œæ™¨2:30é‡ç½®Setæ¡¶
```

## APIè¯´æ˜

### SimpleRedisLimiter

#### getToken()
è·å–ä¸€ä¸ªç®€å•ä»¤ç‰Œï¼Œä¸å­˜å‚¨ä»»ä½•æ ‡è¯†ä¿¡æ¯ã€‚

**è¿”å›å€¼**ï¼š`boolean` - æ˜¯å¦è·å–æˆåŠŸ

#### getToken(String something)
ä¸ºç‰¹å®šå­—ç¬¦ä¸²è·å–ä»¤ç‰Œï¼Œå¹¶å°†è¯¥å­—ç¬¦ä¸²å­˜å‚¨åˆ°Seté›†åˆä¸­ã€‚

**å‚æ•°**ï¼š
- `something` - è¦é™æµçš„æ ‡è¯†å­—ç¬¦ä¸²

**è¿”å›å€¼**ï¼š`int` - ç»“æœä»£ç 
- `1` - è·å–æˆåŠŸ
- `0` - ä»¤ç‰Œä¸è¶³ï¼ˆé™æµï¼‰
- `2` - æ ‡è¯†å·²å­˜åœ¨ï¼ˆå»é‡ï¼‰

#### getToken(String something, boolean hash)
ä¸ºç‰¹å®šå­—ç¬¦ä¸²è·å–ä»¤ç‰Œï¼Œå¯é€‰æ‹©æ˜¯å¦ä½¿ç”¨å“ˆå¸Œå­˜å‚¨ã€‚

**å‚æ•°**ï¼š
- `something` - è¦é™æµçš„æ ‡è¯†å­—ç¬¦ä¸²
- `hash` - æ˜¯å¦ä½¿ç”¨å“ˆå¸Œå­˜å‚¨ï¼ˆèŠ‚çœå†…å­˜ï¼‰

**è¿”å›å€¼**ï¼š`int` - ç»“æœä»£ç ï¼ˆåŒä¸Šï¼‰

#### initializeBuckets()
æ‰‹åŠ¨åˆå§‹åŒ–å­˜å‚¨æ¡¶ï¼Œé€šå¸¸åœ¨åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨è°ƒç”¨ã€‚

## å·¥ä½œåŸç†

### Tokenæ¡¶ç®—æ³•
1. åˆå§‹åŒ–æ—¶è®¾ç½®å›ºå®šæ•°é‡çš„ä»¤ç‰Œ
2. æ¯æ¬¡è¯·æ±‚æ¶ˆè€—ä¸€ä¸ªä»¤ç‰Œ
3. ä»¤ç‰Œæ¶ˆè€—å®Œæ¯•åè§¦å‘é™æµ
4. æ ¹æ®Cronè¡¨è¾¾å¼å®šæ—¶é‡ç½®ä»¤ç‰Œæ•°é‡

### Seté›†åˆç®—æ³•
1. ç»“åˆTokenæ¡¶å’ŒSeté›†åˆå­˜å‚¨
2. è¯·æ±‚æ—¶å…ˆæ£€æŸ¥æ ‡è¯†æ˜¯å¦å·²å­˜åœ¨äºSetä¸­
3. å¦‚æœå­˜åœ¨åˆ™è¿”å›å»é‡ç»“æœï¼ˆ2ï¼‰
4. å¦‚æœä¸å­˜åœ¨åˆ™å°è¯•è·å–Token
5. è·å–æˆåŠŸåå°†æ ‡è¯†åŠ å…¥Set

### åˆ†å¸ƒå¼å®‰å…¨
1. ä½¿ç”¨Redisåˆ†å¸ƒå¼é”ç¡®ä¿åªæœ‰ä¸€ä¸ªå®ä¾‹æ‰§è¡Œåˆå§‹åŒ–
2. é”çš„è¿‡æœŸæ—¶é—´é˜²æ­¢æ­»é”
3. é‡è¯•æœºåˆ¶å¤„ç†ç½‘ç»œæŠ–åŠ¨ç­‰å¼‚å¸¸æƒ…å†µ

## ç›‘æ§ä¸æ—¥å¿—

é™æµå™¨æä¾›è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºï¼ŒåŒ…æ‹¬ï¼š
- åˆå§‹åŒ–è¿‡ç¨‹æ—¥å¿—
- Tokenè·å–ç»“æœæ—¥å¿—
- å®šæ—¶ä»»åŠ¡æ‰§è¡Œæ—¥å¿—
- åˆ†å¸ƒå¼é”è·å–æ—¥å¿—

å¯ä»¥é€šè¿‡é…ç½®æ—¥å¿—çº§åˆ«æ¥æ§åˆ¶è¾“å‡ºï¼š

```yaml
logging:
  level:
    io.github.surezzzzzz.sdk.limiter.redis: DEBUG
```

## æ€§èƒ½å»ºè®®

1. **åˆç†è®¾ç½®Tokenæ•°é‡**ï¼šæ ¹æ®ä¸šåŠ¡QPSå’Œé‡ç½®å‘¨æœŸè®¡ç®—åˆé€‚çš„Tokenæ•°é‡
2. **ä¼˜åŒ–Cronè¡¨è¾¾å¼**ï¼šé¿å…è¿‡äºé¢‘ç¹çš„é‡ç½®æ“ä½œ
3. **ä½¿ç”¨å“ˆå¸Œå­˜å‚¨**ï¼šå¯¹äºé•¿å­—ç¬¦ä¸²æ ‡è¯†ï¼Œå»ºè®®ä½¿ç”¨å“ˆå¸Œå­˜å‚¨èŠ‚çœå†…å­˜
4. **ç›‘æ§Redisæ€§èƒ½**ï¼šå…³æ³¨Redisçš„CPUå’Œå†…å­˜ä½¿ç”¨æƒ…å†µ

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

**Q: é™æµå™¨ä¸ç”Ÿæ•ˆï¼Ÿ**
A: æ£€æŸ¥é…ç½®æ˜¯å¦æ­£ç¡®å¯ç”¨ï¼š`io.github.surezzzzzz.sdk.limiter.redis.enable=true`

**Q: æ‰€æœ‰è¯·æ±‚éƒ½è¢«é™æµï¼Ÿ**
A: æ£€æŸ¥Tokenæ¡¶å¤§å°é…ç½®ï¼Œç¡®è®¤æ˜¯å¦Tokenæ•°é‡è®¾ç½®è¿‡å°

**Q: åˆ†å¸ƒå¼ç¯å¢ƒä¸‹æ•°æ®ä¸ä¸€è‡´ï¼Ÿ**
A: æ£€æŸ¥Redisè¿æ¥æ˜¯å¦æ­£å¸¸ï¼Œåˆ†å¸ƒå¼é”æ˜¯å¦æ­£ç¡®å·¥ä½œ

### è°ƒè¯•æ¨¡å¼

å¼€å¯è°ƒè¯•æ—¥å¿—è·å–æ›´å¤šä¿¡æ¯ï¼š

```yaml
logging:
  level:
    io.github.surezzzzzz.sdk.limiter.redis: DEBUG
    org.springframework.data.redis: DEBUG
```
