spring:
  application:
    name: smart-limiter-test

# 智能限流器配置
io:
  github:
    surezzzzzz:
      sdk:
        limiter:
          redis:
            smart:
              enable: true
              me: test-service
              mode: both  # 同时支持注解和拦截器
              redis:
                command-timeout: 3000         # 命令超时：3秒

              # 注解模式配置（SmartLimiterTest使用）
              annotation:
                default-key-strategy: method
                default-fallback: allow  # ✅ 新增：注解模式默认降级策略
                default-limits:
                  - count: 100
                    window: 1
                    unit: seconds

              # 拦截器模式配置（SmartLimiterWebTest使用）
              interceptor:
                default-key-strategy: path
                default-fallback: allow  # ✅ 新增：拦截器模式默认降级策略
                default-limits:
                  - count: 50
                    window: 10
                    unit: seconds

                exclude-patterns:
                  - /swagger-ui/**
                  - /v3/api-docs/**
                  - /api/health

                rules:
                  # 规则1：/api/public/** GET请求，每个路径独立限流
                  - path-pattern: /api/public/**
                    method: GET
                    key-strategy: path
                    fallback: allow  # ✅ 新增：查询接口Redis异常时放行
                    limits:
                      - count: 5
                        window: 10
                        unit: seconds

                  # 规则2：/api/user/** GET请求，每个用户ID独立限流
                  - path-pattern: /api/user/**
                    method: GET
                    key-strategy: path
                    fallback: allow  # ✅ 新增：查询接口Redis异常时放行
                    limits:
                      - count: 10
                        window: 10
                        unit: seconds

                  # 规则3：/api/user/** POST请求，所有用户共享限流
                  - path-pattern: /api/user/**
                    method: POST
                    key-strategy: path-pattern
                    fallback: deny  # ✅ 新增：写操作Redis异常时拒绝
                    limits:
                      - count: 5
                        window: 10
                        unit: seconds

                  # 规则4：精确路径 /api/user/123，优先级最高
                  - path-pattern: /api/user/123
                    method: GET
                    key-strategy: path
                    # ✅ 不设置fallback，使用拦截器默认降级策略（allow）
                    limits:
                      - count: 15
                        window: 10
                        unit: seconds

              # 降级策略
              fallback:
                on-redis-error: deny  # 全局降级策略：Redis异常时拒绝请求

              # 异常处理
              management:
                enable-default-exception-handler: true

# 日志配置
logging:
  level:
    io.github.surezzzzzz.sdk.limiter.redis.smart: DEBUG
    redis.embedded: WARN
    org.springframework: WARN
